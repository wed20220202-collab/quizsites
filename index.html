<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‚¯ã‚¤ã‚ºã‚µã‚¤ãƒˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #111;
  color: #fff;
  padding: 20px;
}

select, button {
  padding: 8px;
  font-size: 16px;
  margin: 5px 5px 10px 0;
}

.quiz {
  margin: 12px 0;
  padding: 10px;
  border-bottom: 1px solid #333;
}

.question { margin-bottom: 6px; }
.answer { margin-top: 6px; }

.correct { color: #4caf50; font-weight: bold; }
.wrong   { color: #f44336; font-weight: bold; }
</style>
</head>

<body>

<h2>ğŸ“˜ ã‚¯ã‚¤ã‚º</h2>

<label>åœ°åŸŸï¼š</label>
<select id="region">
  <option value="all.xlsx">å…¨å›½</option>
  <option value="metropolitan.xlsx">é¦–éƒ½åœ</option>
  <option value="tokyo.xlsx">æ±äº¬éƒ½</option>
</select>

<label>ãƒ¬ãƒ™ãƒ«ï¼š</label>
<select id="level">
  <option value="easy">Easy</option>
  <option value="normal">Normal</option>
  <option value="hard">Hard</option>
</select>

<label>å‡ºé¡Œæ•°ï¼š</label>
<select id="questionCount">
  <option value="10">10å•</option>
  <option value="20">20å•</option>
  <option value="30">30å•</option>
  <option value="50">50å•</option>
</select>

<br>

<button onclick="startQuiz()">é–‹å§‹</button>
<button onclick="checkAnswers()">ç­”ãˆåˆã‚ã›</button>

<hr>

<div id="quiz-area"></div>
<div id="result"></div>

<script>
// ===============================
// ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚³ãƒ¼ãƒ‰ï¼ˆå›ºå®šï¼‰
// ===============================
const CHOICES = [
  "C010","C011","C020","C030","C040","C041","C060","C070","C080","C081",
  "C090","C100","C110","C113","C114","C115","C116","C118","C119","C120",
  "C121","C122","C123","C124","C126","C128","C129","C130","C131","C132",
  "C133","C134","C135","C136","C137","C138","C140","C141","C142","C143",
  "C144","C145","C146","C147","C148","C149","C150","C160","C170","C190",
  "C200","C210","C211","C220","C221","C222","C230","C231","C232","C233",
  "C234","C235","C236","C240","C241","C250","C261","C271","C272","C273",
  "C274","C275","C277","C278","C280","C281","C282","C283","C284","C290",
  "C330","C340","C370","C400","C401","C430","C440",
  "C12A","C12B","C13A","C13B","C13C","C13D","C13E","C13F","C13H","C13I","C13J",
  "C14A"
];

let allQuestions = [];
let currentQuestions = [];

// ===============================
// Excelèª­è¾¼ï¼ˆåœ°åŸŸåˆ‡æ›¿ï¼‰
// ===============================
async function loadExcel() {
  const file = document.getElementById("region").value;
  const res = await fetch(file);
  const data = await res.arrayBuffer();
  const wb = XLSX.read(data, { type: "array" });
  const sheet = wb.Sheets[wb.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
  allQuestions = rows.filter(r => r[0] && r[1]);
}

// ===============================
// ã‚¯ã‚¤ã‚ºé–‹å§‹
// ===============================
async function startQuiz() {
  await loadExcel();

  const level = document.getElementById("level").value;
  const count = Number(document.getElementById("questionCount").value);

  currentQuestions = shuffle([...allQuestions]).slice(0, count);

  const quizArea = document.getElementById("quiz-area");
  quizArea.innerHTML = "";
  document.getElementById("result").textContent = "";

  currentQuestions.forEach((row, i) => {
    const shop = row[0];
    const code = row[1];

    const div = document.createElement("div");
    div.className = "quiz";
    div.dataset.shop = shop;
    div.dataset.answer = code;

    // ===== Easy =====
    if (level === "easy") {
      div.innerHTML = `
        <div class="question">Q${i+1}. ${shop}</div>
        <div class="answer">
          ${codeSelect()}
          <div class="judge"></div>
        </div>`;
    }

    // ===== Normal =====
    if (level === "normal") {
      // è©²å½“ã‚³ãƒ¼ãƒ‰ã®åº—èˆ—ã‚’æŠ½å‡º
      const sameShops = allQuestions.filter(q => q[1] === code);
      div.dataset.correctShops = sameShops.map(s => s[0]).join(",");

      // ãƒ©ãƒ³ãƒ€ãƒ ã«ä»–ã®åº—èˆ—ã‚‚æ··ãœã¦5ï½6å€‹ç¨‹åº¦ã«ã™ã‚‹
      const choices = shuffle([...allQuestions])
        .map(q => q[0])
        .filter(s => !sameShops.map(x=>x[0]).includes(s))
        .slice(0, 5); // ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ€ãƒŸãƒ¼åº—èˆ—
      const options = shuffle([...sameShops.map(s=>s[0]), ...choices]);

      div.innerHTML = `
        <div class="question">
          Q${i+1}. ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚³ãƒ¼ãƒ‰ï¼š${code} ã«è©²å½“ã™ã‚‹åº—èˆ—ã‚’é¸ã‚“ã§ãã ã•ã„
          <div>
            ${options.map(s =>
              `<label><input type="checkbox" value="${s}"> ${s}</label>`
            ).join("<br>")}
          </div>
        </div>
        <div class="answer"><div class="judge"></div></div>`;
    }

    // ===== Hard =====
    if (level === "hard") {
      const same = allQuestions.filter(q => q[1] === code);
      const sample = shuffle([...same]).slice(0, 5);
      div.dataset.correctShops = same.map(s => s[0]).join(",");

      div.innerHTML = `
        <div class="question">
          Q${i+1}. è©²å½“ã™ã‚‹åº—èˆ—ã¨ã‚³ãƒ¼ãƒ‰ã‚’é¸æŠ
          <div>
            ${sample.map(s =>
              `<label><input type="checkbox" value="${s[0]}"> ${s[0]}</label>`
            ).join("<br>")}
          </div>
        </div>
        <div class="answer">
          ${codeSelect()}
          <div class="judge"></div>
        </div>`;
    }

    quizArea.appendChild(div);
  });
}

// ===============================
// ç­”ãˆåˆã‚ã›
// ===============================
function checkAnswers() {
  const level = document.getElementById("level").value;
  let correct = 0;
  let answeredCount = 0; // é¸æŠæ¸ˆã¿å•é¡Œã®ã‚«ã‚¦ãƒ³ãƒˆ

  document.querySelectorAll(".quiz").forEach(q => {
    const judge = q.querySelector(".judge");

    if (level === "easy") {
      const val = q.querySelector("select").value;
      if (!val) { judge.textContent = ""; return; }
      answeredCount++;
      if (val === q.dataset.answer) {
        correct++; 
        judge.textContent = "æ­£è§£"; 
        judge.className = "judge correct";
      } else {
        judge.textContent = `ä¸æ­£è§£ï¼ˆ${q.dataset.answer}ï¼‰`; 
        judge.className = "judge wrong";
      }
    }

    if (level === "normal") {
      const selectedShops = [...q.querySelectorAll("input:checked")].map(i => i.value);
      if (selectedShops.length === 0) { judge.textContent = ""; return; }
      answeredCount++;
    
      const correctShops = q.dataset.correctShops.split(",");
    
      // é¸æŠæ¸ˆã¿ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«æ­£è§£è¡¨ç¤ºï¼ˆãƒã‚§ãƒƒã‚¯ã¯ãã®ã¾ã¾ï¼‰
      selectedShops.forEach(shop => {
        if (correctShops.includes(shop)) {
          const label = [...q.querySelectorAll("input")]
                        .find(i => i.value === shop)
                        .parentElement;
          // æ—¢ã«æ­£è§£è¡¨ç¤ºãŒä»˜ã„ã¦ã„ã‚‹å ´åˆã¯è¿½åŠ ã—ãªã„
          if (!label.querySelector(".correct")) {
            const span = document.createElement("span");
            span.className = "correct";
            span.textContent = " æ­£è§£";
            label.appendChild(span);
          }
        }
      });
    
      // å•é¡Œå…¨ä½“ã®åˆ¤å®š
      const shopOK = selectedShops.every(s => correctShops.includes(s)) &&
                     selectedShops.length === correctShops.length;
    
      if (shopOK) {
        correct++;
        judge.textContent = "æ­£è§£"; 
        judge.className = "judge correct";
      } else {
        judge.textContent = `ä¸æ­£è§£ï¼ˆ${correctShops.join(", ")}ï¼‰`; 
        judge.className = "judge wrong";
      }
    }

    if (level === "hard") {
      const codeVal = q.querySelector("select").value;
      const shopVals = [...q.querySelectorAll("input:checked")].map(i => i.value);
      if (!codeVal && shopVals.length === 0) { judge.textContent = ""; return; }
      answeredCount++;

      const codeOK = codeVal === q.dataset.answer;
      const correctShops = q.dataset.correctShops.split(",");
      const shopOK = shopVals.every(s => correctShops.includes(s));

      if (codeOK && shopOK) {
        correct++; 
        judge.textContent = "æ­£è§£"; 
        judge.className = "judge correct";
      } else {
        judge.textContent = "ä¸æ­£è§£"; 
        judge.className = "judge wrong";
      }
    }
  });

  document.getElementById("result").textContent =
    `çµæœï¼š${correct} / ${answeredCount} å• æ­£è§£`;
}

// ===============================
// å…±é€šéƒ¨å“
// ===============================
function codeSelect() {
  return `
    <select>
      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
      ${CHOICES.map(c => `<option value="${c}">${c}</option>`).join("")}
    </select>`;
}

function shuffle(a) {
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
</script>

</body>
</html>
