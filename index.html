<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åœ°åŸŸ Ã— é›£æ˜“åº¦ã‚¯ã‚¤ã‚º</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body {
  font-family: system-ui, sans-serif;
  background:#111;
  color:#fff;
  padding:20px;
}
select, button {
  padding:8px;
  margin:5px 0;
}
.quiz-box {
  margin-top:20px;
  padding:15px;
  background:#222;
  border-radius:8px;
}
.choice {
  margin:5px 0;
}
</style>
</head>
<body>

<h2>ğŸ§  ã‚¯ã‚¤ã‚ºè¨­å®š</h2>

<label>åœ°åŸŸé›£æ˜“åº¦</label><br>
<select id="region">
  <option value="all.xlsx">å…¨å›½</option>
  <option value="metropolitan.xlsx">é¦–éƒ½åœ</option>
  <option value="tokyo.xlsx">æ±äº¬éƒ½</option>
</select><br>

<label>ã‚²ãƒ¼ãƒ é›£æ˜“åº¦</label><br>
<select id="difficulty">
  <option value="easy">Easy</option>
  <option value="normal">Normal</option>
  <option value="hard">Hard</option>
</select><br>

<label>å•é¡Œæ•°</label><br>
<select id="count">
  <option>10</option>
  <option>20</option>
  <option>30</option>
  <option>50</option>
</select><br>

<button onclick="startGame()">START</button>

<div id="quiz" class="quiz-box"></div>
<button id="checkBtn" style="display:none" onclick="checkAnswer()">ç­”ãˆåˆã‚ã›</button>

<script>
let data = [];
let current = null;
let correct = null;

async function startGame() {
  const file = document.getElementById("region").value;
  const diff = document.getElementById("difficulty").value;

  const res = await fetch(file);
  const buf = await res.arrayBuffer();
  const wb = XLSX.read(buf, {type:"array"});
  const ws = wb.Sheets[wb.SheetNames[0]];
  data = XLSX.utils.sheet_to_json(ws, {header:1});

  generateQuestion(diff);
}

function generateQuestion(diff) {
  const q = data[Math.floor(Math.random()*data.length)];
  const shop = q[0];
  const code = q[1];
  const quiz = document.getElementById("quiz");
  quiz.innerHTML = "";

  if(diff === "easy"){
    quiz.innerHTML = `<h3>${shop}</h3>`;
    quiz.innerHTML += codeSelect();
    correct = code;
  }

  if(diff === "normal"){
    quiz.innerHTML = `<h3>ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚³ãƒ¼ãƒ‰ï¼š${code}</h3>`;
    quiz.innerHTML += shopSelect();
    correct = shop;
  }

  if(diff === "hard"){
    const sameCode = data.filter(d => d[1] === code);
    const display = sameCode.sort(()=>0.5-Math.random()).slice(0,5);

    quiz.innerHTML = `<h3>è©²å½“ã™ã‚‹åº—èˆ—ã¨ã‚³ãƒ¼ãƒ‰ã‚’é¸ã¹</h3>`;
    quiz.innerHTML += codeSelect();
    display.forEach(s=>{
      quiz.innerHTML += `
        <div>
          <input type="checkbox" value="${s[0]}"> ${s[0]}
        </div>`;
    });

    correct = {
      code: code,
      shops: sameCode.map(s=>s[0])
    };
  }

  document.getElementById("checkBtn").style.display="block";
}

function codeSelect(){
  return `
  <select id="answer">
    <option>CODE-A</option>
    <option>CODE-B</option>
    <option>CODE-C</option>
    <option>CODE-D</option>
  </select>`;
}

function shopSelect(){
  let html = `<select id="answer">`;
  data.forEach(d=>{
    html += `<option>${d[0]}</option>`;
  });
  html += `</select>`;
  return html;
}

function checkAnswer(){
  const diff = document.getElementById("difficulty").value;

  if(diff !== "hard"){
    const ans = document.getElementById("answer").value;
    alert(ans === correct ? "â­• æ­£è§£" : "âŒ ä¸æ­£è§£");
    return;
  }

  const codeAns = document.getElementById("answer").value;
  const shopAns = [...document.querySelectorAll("input[type=checkbox]:checked")]
                  .map(c=>c.value);

  const ok =
    codeAns === correct.code &&
    shopAns.every(s => correct.shops.includes(s));

  alert(ok ? "â­• æ­£è§£" : "âŒ ä¸æ­£è§£");
}
</script>

</body>
</html>
