<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‚¯ã‚¤ã‚ºã‚µã‚¤ãƒˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #111;
  color: #fff;
  padding: 20px;
}

select, button {
  padding: 8px;
  font-size: 16px;
  margin: 5px 5px 10px 0;
}

.quiz {
  margin: 12px 0;
  padding: 10px;
  border-bottom: 1px solid #333;
}

.question { margin-bottom: 6px; }
.answer { margin-top: 6px; }

.correct { color: #4caf50; font-weight: bold; }
.wrong   { color: #f44336; font-weight: bold; }
</style>
</head>
<body>

<h2>ğŸ“˜ ã‚¯ã‚¤ã‚º</h2>

<label>åœ°åŸŸï¼š</label>
<select id="region">
  <option value="all.xlsx">å…¨å›½</option>
  <option value="metropolitan.xlsx">é¦–éƒ½åœ</option>
  <option value="tokyo.xlsx">æ±äº¬éƒ½</option>
</select>

<label>ãƒ¬ãƒ™ãƒ«ï¼š</label>
<select id="level">
  <option value="easy">Easy</option>
  <option value="normal">Normal</option>
  <option value="hard">Hard</option>
</select>

<label>å‡ºé¡Œæ•°ï¼š</label>
<select id="questionCount">
  <option value="10">10å•</option>
  <option value="20">20å•</option>
  <option value="30">30å•</option>
  <option value="50">50å•</option>
</select>

<br>
<button onclick="startQuiz()">é–‹å§‹</button>
<button onclick="checkAnswers()">ç­”ãˆåˆã‚ã›</button>
<hr>

<div id="quiz-area"></div>
<div id="result"></div>

<script>
// ===============================
// ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚³ãƒ¼ãƒ‰
// ===============================
const CHOICES = [
  "C010","C011","C020","C030","C040","C041","C060","C070","C080","C081",
  "C090","C100","C110","C113","C114","C115","C116","C118","C119","C120",
  "C121","C122","C123","C124","C126","C128","C129","C130","C131","C132",
  "C133","C134","C135","C136","C137","C138","C140","C141","C142","C143",
  "C144","C145","C146","C147","C148","C149","C150","C160","C170","C190",
  "C200","C210","C211","C220","C221","C222","C230","C231","C232","C233",
  "C234","C235","C236","C240","C241","C250","C261","C271","C272","C273",
  "C274","C275","C277","C278","C280","C281","C282","C283","C284","C290",
  "C330","C340","C370","C400","C401","C430","C440",
  "C12A","C12B","C13A","C13B","C13C","C13D","C13E","C13F","C13H","C13I","C13J",
  "C14A"
];

let allQuestions = [];
let currentQuestions = [];

// ===============================
// Excelèª­è¾¼
// ===============================
async function loadExcel() {
  const file = document.getElementById("region").value;
  const res = await fetch(file);
  const data = await res.arrayBuffer();
  const wb = XLSX.read(data, { type: "array" });
  const sheet = wb.Sheets[wb.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
  allQuestions = rows.filter(r => r[0] && r[1]);
}

// ===============================
// ã‚¯ã‚¤ã‚ºé–‹å§‹
// ===============================
async function startQuiz() {
  await loadExcel();

  const level = document.getElementById("level").value;
  const count = Number(document.getElementById("questionCount").value);

  currentQuestions = shuffle([...allQuestions]).slice(0, count);

  const quizArea = document.getElementById("quiz-area");
  quizArea.innerHTML = "";
  document.getElementById("result").textContent = "";

  currentQuestions.forEach((row, i) => {
    const shop = row[0];
    const code = row[1];
    const div = document.createElement("div");
    div.className = "quiz";
    div.dataset.shop = shop;
    div.dataset.answer = code;

    // ===== Easy =====
    if(level==="easy"){
      div.innerHTML = `
        <div class="question">Q${i+1}. ${shop}</div>
        <div class="answer">
          ${codeSelect()}
          <div class="judge"></div>
        </div>`;
    }

    // ===== Normal =====
    if(level==="normal"){
      const sameShops = allQuestions.filter(q=>q[1]===code);
      div.dataset.correctShops = sameShops.map(s=>s[0]).join(",");

      // ãƒ€ãƒŸãƒ¼ã‚’è¿½åŠ ã—ã¦é¸æŠè‚¢10å€‹ç¨‹åº¦ã«
      const choices = shuffle([...allQuestions])
        .map(q=>q[0])
        .filter(s=>!sameShops.map(x=>x[0]).includes(s))
        .slice(0,5);
      const options = shuffle([...sameShops.map(s=>s[0]),...choices]);

      div.innerHTML = `
        <div class="question">
          Q${i+1}. ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚³ãƒ¼ãƒ‰ï¼š${code} ã«è©²å½“ã™ã‚‹åº—èˆ—ã‚’é¸ã‚“ã§ãã ã•ã„
          <div>
            ${options.map(s=>`<label><input type="checkbox" value="${s}"> ${s}</label>`).join("<br>")}
          </div>
        </div>
        <div class="answer"><div class="judge"></div></div>`;
    }

    // Hardå•é¡Œç”Ÿæˆ
    if(level==="hard"){
      // ã¾ãšãƒ©ãƒ³ãƒ€ãƒ ã«ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚³ãƒ¼ãƒ‰ã‚’1ã¤é¸ã¶
      const communityCodes = [...new Set(allQuestions.map(q=>q[1]))];
      const code = communityCodes[Math.floor(Math.random()*communityCodes.length)];
    
      // åŒã˜ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£å†…ã®åº—èˆ—ã‚’å–å¾—
      const communityShops = allQuestions.filter(q=>q[1]===code).map(q=>q[0]);
    
      // ãã®ä¸­ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«2åº—èˆ—ã‚’å•é¡Œç”¨ã«é¸ã¶
      const sampleShops = shuffle([...communityShops]).slice(0,2);
    
      div.dataset.correctCode = code; // ã‚³ãƒ¼ãƒ‰æ­£è§£
      div.dataset.correctRemaining = communityShops.filter(s=>!sampleShops.includes(s)).join(",");
    
      // æ®‹ã‚Šåº—èˆ—ã®é¸æŠè‚¢ï¼ˆ2åº—èˆ—é™¤ãã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£å†…åº—èˆ—ï¼‰
      const remainingOptions = shuffle([...communityShops.filter(s=>!sampleShops.includes(s))]);
    
      div.innerHTML = `
        <div class="question">
          Q${i+1}. ä¸‹è¨˜2åº—èˆ—ã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚³ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ãã ã•ã„<br>
          ${sampleShops.join(" / ")}
        </div>
        <div class="answer">
          <label>ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚³ãƒ¼ãƒ‰ï¼š
            <select>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              ${CHOICES.map(c=>`<option value="${c}">${c}</option>`).join("")}
            </select>
          </label>
          <div>
            æ®‹ã‚Šåº—èˆ—ã‚’é¸æŠ:<br>
            ${remainingOptions.map(s=>`<label><input type="checkbox" value="${s}"> ${s}</label>`).join("<br>")}
          </div>
          <div class="judge"></div>
        </div>`;
    }

    quizArea.appendChild(div);
  });
}

// ===============================
// ç­”ãˆåˆã‚ã›
// ===============================
function checkAnswers(){
  const level = document.getElementById("level").value;
  let totalScore = 0;
  let answeredCount = 0;

  document.querySelectorAll(".quiz").forEach((q, idx)=>{
    const judge = q.querySelector(".judge");
    let score = 0;

    if(level==="easy"){
      const val = q.querySelector("select").value;
      if(!val){ judge.textContent=""; return; }
      answeredCount++;
      if(val===q.dataset.answer){
        score=1;
        judge.textContent="æ­£è§£"; judge.className="judge correct";
      }else{
        judge.textContent=`ä¸æ­£è§£ï¼ˆ${q.dataset.answer}ï¼‰`; judge.className="judge wrong";
      }
      totalScore+=score;
    }

    if(level==="normal"){
      const checkboxes = [...q.querySelectorAll("input")];
      const selected = checkboxes.filter(i=>i.checked).map(i=>i.value);
      if(selected.length===0){ judge.textContent=""; return; }
      answeredCount++;

      const correctShops = q.dataset.correctShops.split(",");
      let correctMarked=false;

      checkboxes.forEach(cb=>{
        const label = cb.parentElement;
        if(cb.checked && !correctShops.includes(cb.value)){
          cb.checked=false;
        }
        if(cb.checked && correctShops.includes(cb.value) && !correctMarked){
          cb.disabled=true;
          if(!label.querySelector(".correct")){
            const span = document.createElement("span");
            span.className="correct"; span.textContent=" æ­£è§£";
            label.appendChild(span);
          }
          correctMarked=true;
        }
      });

      const finalSelected=checkboxes.filter(i=>i.checked).map(i=>i.value);
      const shopOK = finalSelected.every(s=>correctShops.includes(s)) && finalSelected.length===correctShops.length;

      if(shopOK){ score=1; judge.textContent="æ­£è§£"; judge.className="judge correct"; }
      else{ judge.textContent=`ä¸æ­£è§£ï¼ˆ${correctShops.join(", ")})`; judge.className="judge wrong"; }

      totalScore+=score;
    }

    // Hardå•é¡Œæ¡ç‚¹
    if(level==="hard"){
      let score=0;
      answeredCount++;
      const codeVal = q.querySelector("select").value;
      const remainingCB = [...q.querySelectorAll("input")];
      const remainingSelected = remainingCB.filter(i=>i.checked).map(i=>i.value);
    
      const correctCode = q.dataset.correctCode;
      const correctRemaining = q.dataset.correctRemaining.split(",");
    
      // ã‚³ãƒ¼ãƒ‰æ¡ç‚¹
      if(codeVal===correctCode){
        score+=1;
        q.querySelector("select").disabled=true; // ãƒ­ãƒƒã‚¯
      }
    
      // æ®‹ã‚Šåº—èˆ—æ¡ç‚¹ï¼ˆå…¨æ­£è§£ãƒã‚§ãƒƒã‚¯ã‚’ãƒ­ãƒƒã‚¯ï¼‰
      remainingCB.forEach(cb=>{
        const label = cb.parentElement;
      
        if(correctRemaining.includes(cb.value)){
          // æ­£è§£ãƒã‚§ãƒƒã‚¯ã¯å…¨ã¦ãƒ­ãƒƒã‚¯ & æ­£è§£ãƒãƒ¼ã‚¯
          cb.disabled = true;
          if(!label.querySelector(".correct")){
            const span = document.createElement("span");
            span.className = "correct";
            span.textContent = " æ­£è§£";
            label.appendChild(span);
          }
        } else {
          // ä¸æ­£è§£ãƒã‚§ãƒƒã‚¯ã¯å¤–ã™
          if(cb.checked) cb.checked = false;
        }
      });
    
      // æ®‹ã‚Šåº—èˆ—å®Œå…¨æ­£è§£ã§ +1ç‚¹
      const finalRemaining = remainingCB.filter(i=>i.checked).map(i=>i.value);
      const remainingOK = finalRemaining.every(s=>correctRemaining.includes(s)) &&
                          finalRemaining.length===correctRemaining.length;
      if(remainingOK) score+=1;
    
      // å•é¡Œã”ã¨ã®è¡¨ç¤º
      if(score===2) judge.textContent="å®Œå…¨æ­£è§£";
      else if(score===1) judge.textContent="éƒ¨åˆ†æ­£è§£";
      else judge.textContent=`ä¸æ­£è§£ï¼ˆã‚³ãƒ¼ãƒ‰:${correctCode} / æ®‹åº—èˆ—:${correctRemaining.join(", ")})`;
      judge.className = score>0?"judge correct":"judge wrong";
    
      totalScore+=score;
    }

    q.dataset.score=score;
  });

  document.getElementById("result").textContent = `ç·åˆå¾—ç‚¹ï¼š${totalScore} / ${answeredCount*2} ç‚¹`;
}

// ===============================
// å…±é€šéƒ¨å“
// ===============================
function codeSelect(){
  return `<select><option value="">é¸æŠã—ã¦ãã ã•ã„</option>${CHOICES.map(c=>`<option value="${c}">${c}</option>`).join("")}</select>`;
}

function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
</script>

</body>
</html>
